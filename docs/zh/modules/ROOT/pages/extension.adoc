= 扩展点
:page-pagination:

Netty Spring Boot Starter 提供多个扩展点用于自定义。

== 自定义 Profile

创建自定义协议 Profile：

[source,java]
----
@Component
public class MyCustomProfile implements Profile {

    @Override
    public String getName() {
        return "my-custom-profile";
    }

    @Override
    public void configure(ChannelPipeline pipeline, ServerSpec serverSpec) {
        pipeline.addLast("myDecoder", new MyDecoder());
        pipeline.addLast("myEncoder", new MyEncoder());
    }

    @Override
    public String getProtocolType() {
        return NettyContext.PROTOCOL_TCP;
    }
}
----

在配置中使用：

[source,yaml]
----
spring:
  netty:
    servers:
      - name: my-server
        profile: my-custom-profile
----

== 自定义编解码器

创建自定义序列化编解码器：

[source,java]
----
@Component
public class ProtobufCodec implements NettyCodec {

    @Override
    public String getName() {
        return "protobuf";
    }

    @Override
    public byte[] encode(Object object) {
        return ((Message) object).toByteArray();
    }

    @Override
    public <T> T decode(byte[] bytes, Class<T> targetType) {
        try {
            Method parseFrom = targetType.getMethod("parseFrom", byte[].class);
            return targetType.cast(parseFrom.invoke(null, bytes));
        } catch (Exception e) {
            throw new RuntimeException("Failed to decode protobuf", e);
        }
    }
}
----

== Pipeline 配置器

为特定服务器添加自定义处理器：

[source,java]
----
@Component
public class MyPipelineConfigurer implements NettyPipelineConfigurer {

    @Override
    public void configure(ChannelPipeline pipeline, ServerSpec serverSpec) {
        // 在 dispatcher 之前添加处理器
        pipeline.addBefore("dispatcherHandler", "myHandler", new MyHandler());
    }

    @Override
    public boolean supports(ServerSpec serverSpec) {
        // 仅应用于特定服务器
        return "my-server".equals(serverSpec.getName());
    }

    @Override
    public int getOrder() {
        return 0;  // 值越小越早执行
    }
}
----

== 自定义路由解析器

创建自定义路由键提取：

[source,java]
----
@Component
public class MyRouteResolver implements NettyRouteResolver {

    @Override
    public String resolveRouteKey(InboundMessage message) {
        // 从自定义头部提取路由键
        return (String) message.getHeader("cmd");
    }

    @Override
    public boolean supports(ServerSpec serverSpec) {
        return "my-server".equals(serverSpec.getName());
    }
}
----

== 自定义参数解析器

创建自定义参数解析：

[source,java]
----
@Component
public class UserArgumentResolver implements ArgumentResolver {

    @Override
    public boolean supports(Parameter parameter) {
        return parameter.getType() == User.class;
    }

    @Override
    public Object resolve(Parameter parameter, InboundMessage message,
                          NettyContext context, Map<String, String> pathVariables) {
        // 从会话或令牌解析 User
        String token = (String) message.getHeader("header.authorization");
        return userService.getUserFromToken(token);
    }
}
----

注册它：

[source,java]
----
@Configuration
public class NettyConfig {

    @Autowired
    public void configureArgumentResolvers(Dispatcher dispatcher) {
        dispatcher.getArgumentResolvers().addResolver(new UserArgumentResolver());
    }
}
----

== 自定义客户端 Profile

创建自定义客户端 Profile：

[source,java]
----
@Component
public class MyClientProfile implements ClientProfile {

    @Override
    public String getName() {
        return "my-client-profile";
    }

    @Override
    public void configure(ChannelPipeline pipeline, ClientSpec clientSpec) {
        pipeline.addLast("myDecoder", new MyDecoder());
        pipeline.addLast("myEncoder", new MyEncoder());
    }
}
----

== 自定义特性提供者

创建自定义特性：

[source,java]
----
@Component
public class MetricsFeatureProvider implements FeatureProvider {

    public static final int ORDER = 180;

    @Override
    public String getName() {
        return "metrics";
    }

    @Override
    public int getOrder() {
        return ORDER;
    }

    @Override
    public boolean isEnabled(ServerSpec serverSpec) {
        Map<String, Object> features = serverSpec.getFeatures();
        if (features == null) return false;
        Map<String, Object> metrics = (Map<String, Object>) features.get("metrics");
        return metrics != null && Boolean.TRUE.equals(metrics.get("enabled"));
    }

    @Override
    public void configure(ChannelPipeline pipeline, ServerSpec serverSpec) {
        pipeline.addLast("metricsHandler", new MetricsHandler());
    }
}
----

配置：

[source,yaml]
----
spring:
  netty:
    servers:
      - name: my-server
        features:
          metrics:
            enabled: true
----
