= 连接池 (Connection Pool)
:page-pagination:

客户端使用连接池高效管理 TCP 连接。本页介绍连接池配置、行为、重连和心跳机制。

== 连接池架构

[source,text]
----
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ConnectionPool                                     │
│                                                                              │
│  配置:                                                                        │
│    maxConnections: 10                                                        │
│    minIdle: 2                                                                │
│    maxIdleMs: 60000                                                          │
│    acquireTimeoutMs: 5000                                                    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                         连接状态                                          ││
│  │                                                                          ││
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐       ││
│  │  │ Channel │  │ Channel │  │ Channel │  │ Channel │  │ Channel │       ││
│  │  │  空闲   │  │  空闲   │  │  活跃   │  │  活跃   │  │  空闲   │       ││
│  │  │ 30秒前  │  │ 5秒前   │  │ 使用中  │  │ 使用中  │  │ 10秒前  │       ││
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘       ││
│  │       │                          │            │                         ││
│  │       └──────────────────────────┼────────────┘                         ││
│  │                                  │                                       ││
│  └──────────────────────────────────┼───────────────────────────────────────┘│
│                                     │                                        │
│  空闲队列 ◄─────────────────────────┘                                        │
│  (可供获取)                                                                   │
└─────────────────────────────────────────────────────────────────────────────┘
----

== 连接池配置

[source,yaml]
----
spring:
  netty:
    clients:
      - name: order-service
        host: 127.0.0.1
        port: 9000
        profile: tcp-lengthfield-json
        pool:
          maxConnections: 10           # <1>
          minIdle: 2                   # <2>
          maxIdleMs: 60000             # <3>
          acquireTimeoutMs: 5000       # <4>
----
<1> 连接池中的最大连接数
<2> 保持的最小空闲连接数
<3> 空闲连接超时关闭时间 (毫秒)
<4> 等待获取连接的超时时间 (毫秒)

=== 配置属性

[cols="2,1,1,4"]
|===
|属性 |默认值 |类型 |描述

|`maxConnections`
|`10`
|int
|连接池中的最大连接数。限制并发请求数量。

|`minIdle`
|`2`
|int
|保持就绪的最小空闲连接数。用于预热连接池。

|`maxIdleMs`
|`60000`
|long
|连接在被驱逐前可以空闲的最大时间 (毫秒)。

|`acquireTimeoutMs`
|`5000`
|long
|获取连接时等待的最大时间 (毫秒)。
|===

== 连接生命周期

[source,text]
----
                    ┌──────────────────────────────────────────┐
                    │              acquire() 获取连接           │
                    │                                          │
                    │    ┌─────────────────────────────────┐   │
                    │    │ 1. 检查空闲队列                   │   │
                    │    │    └─ 有空闲? → 返回              │   │
                    │    │                                 │   │
                    │    │ 2. 检查连接池大小                 │   │
                    │    │    └─ < 最大值? → 创建新连接       │   │
                    │    │                                 │   │
                    │    │ 3. 等待可用连接                   │   │
                    │    │    └─ 超时? → 抛出异常            │   │
                    │    └─────────────────────────────────┘   │
                    │                    │                     │
                    │                    ▼                     │
                    │              ┌─────────┐                │
                    │              │ Channel │                │
                    │              │  活跃   │                │
                    │              └─────────┘                │
                    │                    │                     │
                    │           (请求/响应)                     │
                    │                    │                     │
                    │                    ▼                     │
                    │              release() 释放连接          │
                    │                    │                     │
                    │    ┌───────────────┼───────────────┐    │
                    │    │               │               │    │
                    │    ▼               ▼               ▼    │
                    │  健康?          损坏?          错误?    │
                    │    │               │               │    │
                    │    ▼               ▼               ▼    │
                    │  返回到         丢弃并          丢弃并   │
                    │  空闲队列       重连            重连     │
                    │                                          │
                    └──────────────────────────────────────────┘
----

=== 获取流程

1. **检查空闲队列**: 如果有可用的空闲连接则返回
2. **创建新连接**: 如果连接池未满，创建新连接
3. **等待**: 如果连接池已满，等待连接可用
4. **超时**: 如果等待超过 `acquireTimeoutMs`，抛出异常

=== 释放流程

1. **健康检查**: 验证连接是否仍然有效
2. **健康**: 返回到空闲队列以便重用
3. **损坏**: 丢弃并在需要时触发重连

== 重连 (Reconnection)

当连接断开时，连接池会自动重连。

=== 配置

[source,yaml]
----
spring:
  netty:
    clients:
      - name: order-service
        reconnect:
          enabled: true                # <1>
          initialDelayMs: 1000         # <2>
          maxDelayMs: 30000            # <3>
          multiplier: 2.0              # <4>
          maxRetries: -1               # <5>
----
<1> 启用自动重连
<2> 首次重试前的初始延迟 (毫秒)
<3> 重试之间的最大延迟 (毫秒)
<4> 指数退避乘数
<5> 最大重试次数 (`-1` = 无限)

=== 指数退避

[source,text]
----
连接断开!

重试 1: 等待 1000ms  → 连接... 失败
重试 2: 等待 2000ms  → 连接... 失败
重试 3: 等待 4000ms  → 连接... 失败
重试 4: 等待 8000ms  → 连接... 失败
重试 5: 等待 16000ms → 连接... 失败
重试 6: 等待 30000ms → 连接... 成功! (达到 maxDelayMs 上限)
           └─────────────────────────────────┘
                   指数退避
----

公式: `delay = min(initialDelay * (multiplier ^ attempt), maxDelay)`

=== 重连行为

[source,text]
----
┌─────────────────────────────────────────────────────────────────┐
│                    ReconnectManager                              │
│                                                                  │
│  状态: CONNECTING                                                │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  事件: 连接断开                                               ││
│  │    │                                                         ││
│  │    ▼                                                         ││
│  │  调度重连 (initialDelayMs)                                    ││
│  │    │                                                         ││
│  │    ▼                                                         ││
│  │  尝试连接                                                     ││
│  │    │                                                         ││
│  │    ├─── 成功 ──► 加入连接池，重置退避                          ││
│  │    │                                                         ││
│  │    └─── 失败 ───► 计算下次延迟                                 ││
│  │                       │                                      ││
│  │                       ├─── 达到 maxRetries? ──► 放弃          ││
│  │                       │                                      ││
│  │                       └─── 调度下次尝试                        ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
----

== 心跳 (Heartbeat)

心跳用于保持连接存活并主动检测死连接。

=== 配置

[source,yaml]
----
spring:
  netty:
    clients:
      - name: order-service
        heartbeat:
          enabled: true                          # <1>
          intervalMs: 30000                      # <2>
          timeoutMs: 5000                        # <3>
          message: '{"type":"heartbeat"}'        # <4>
----
<1> 启用心跳
<2> 每 30 秒发送心跳
<3> 等待响应最多 5 秒
<4> 心跳消息内容

=== 心跳流程

[source,text]
----
┌─────────────────────────────────────────────────────────────────┐
│                     HeartbeatManager                             │
│                                                                  │
│  间隔: 30000ms                                                   │
│  超时: 5000ms                                                    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  对于每个空闲连接:                                            ││
│  │    │                                                         ││
│  │    ▼                                                         ││
│  │  发送: {"type":"heartbeat"}                                  ││
│  │    │                                                         ││
│  │    ├─── 5秒内响应 ──► 连接健康                                ││
│  │    │                                                         ││
│  │    └─── 无响应 ─────────► 标记为不健康                         ││
│  │                                   │                          ││
│  │                                   ▼                          ││
│  │                               关闭并重连                      ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  30000ms 后调度下次心跳                                           │
└─────────────────────────────────────────────────────────────────┘
----

=== 服务端心跳处理器

服务端应处理心跳消息：

[source,java]
----
@NettyMessageController
public class HeartbeatHandler {

    @NettyMessageMapping("heartbeat")
    public Map<String, Object> handleHeartbeat(NettyContext context) {
        return Map.of(
            "type", "heartbeat.ack",
            "timestamp", System.currentTimeMillis()
        );
    }
}
----

== 空闲连接管理

=== 驱逐

空闲时间超过 `maxIdleMs` 的连接将被驱逐：

[source,text]
----
连接池状态 (maxIdleMs = 60000):

  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
  │ Channel │  │ Channel │  │ Channel │  │ Channel │
  │  空闲   │  │  空闲   │  │  空闲   │  │  空闲   │
  │ 65秒前  │  │ 30秒前  │  │ 10秒前  │  │ 5秒前   │
  └─────────┘  └─────────┘  └─────────┘  └─────────┘
       │
       ▼
    被驱逐 (空闲 > 60秒)

驱逐后:
  ┌─────────┐  ┌─────────┐  ┌─────────┐
  │ Channel │  │ Channel │  │ Channel │
  │  空闲   │  │  空闲   │  │  空闲   │
  │ 30秒前  │  │ 10秒前  │  │ 5秒前   │
  └─────────┘  └─────────┘  └─────────┘
----

=== 最小空闲数

连接池至少保持 `minIdle` 个连接：

[source,text]
----
连接池状态 (minIdle = 2):

  ┌─────────┐  ┌─────────┐
  │ Channel │  │ Channel │
  │  空闲   │  │  空闲   │
  └─────────┘  └─────────┘

所有连接都已释放，但 minIdle = 2
→ 保持 2 个连接就绪以备下次请求
----

== 超时设置

=== 连接超时

[source,yaml]
----
spring:
  netty:
    clients:
      - name: order-service
        timeout:
          connectMs: 5000              # 连接建立超时
----

=== 获取超时

[source,yaml]
----
spring:
  netty:
    clients:
      - name: order-service
        pool:
          acquireTimeoutMs: 5000       # 等待连接池连接的超时时间
----

=== 请求超时

[source,yaml]
----
spring:
  netty:
    clients:
      - name: order-service
        timeout:
          requestMs: 10000             # 请求/响应超时
----

== 容量规划指南

=== 计算最大连接数

[source,text]
----
maxConnections = (每秒请求数) × (平均响应时间秒数) × 安全系数

示例:
  - 100 请求/秒
  - 50ms 平均响应时间 (0.05 秒)
  - 2 倍安全系数

  maxConnections = 100 × 0.05 × 2 = 10 个连接
----

=== 按使用场景推荐

[cols="2,1,1,3"]
|===
|使用场景 |maxConnections |minIdle |备注

|低流量服务
|5
|1
|资源占用最小

|标准服务
|10
|2
|良好平衡

|高流量服务
|50
|10
|预热以应对突发

|批处理
|100
|5
|高并行度

|实时关键服务
|20
|20
|所有连接就绪
|===

== 监控

=== 连接池指标

可通过 Actuator 获取：

[source,bash]
----
GET /actuator/netty/clients/order-service
----

[source,json]
----
{
  "name": "order-service",
  "host": "127.0.0.1",
  "port": 9000,
  "status": "CONNECTED",
  "pool": {
    "maxConnections": 10,
    "currentSize": 8,
    "activeCount": 3,
    "idleCount": 5,
    "pendingAcquire": 0
  },
  "reconnect": {
    "enabled": true,
    "totalReconnects": 5,
    "lastReconnectTime": "2024-01-30T10:15:30Z"
  }
}
----

=== Micrometer 指标

[cols="2,3"]
|===
|指标 |描述

|`netty.client.pool.size`
|当前连接池大小

|`netty.client.pool.active`
|活跃 (使用中) 连接数

|`netty.client.pool.idle`
|空闲连接数

|`netty.client.pool.pending`
|等待连接的请求数

|`netty.client.reconnect.total`
|总重连尝试次数
|===

== 故障排查

=== 连接池耗尽

[source,text]
----
ERROR: Failed to acquire connection within 5000ms
----

*原因:*

* `maxConnections` 对于流量来说太低
* 连接没有被释放 (泄漏)
* 服务器太慢，连接被占用

*解决方案:*

* 增加 `maxConnections`
* 检查连接泄漏
* 添加异步处理
* 增加服务器容量

=== 频繁重连

[source,text]
----
WARN: Reconnecting to order-service (attempt 5)
----

*原因:*

* 服务器正在重启
* 网络不稳定
* 服务器拒绝连接

*解决方案:*

* 检查服务器健康状况
* 检查网络连接
* 检查服务器连接限制
* 调整 `maxRetries` 和退避设置

=== 心跳超时

[source,text]
----
WARN: Heartbeat timeout for connection, marking unhealthy
----

*原因:*

* 网络拥堵
* 服务器过载
* `timeoutMs` 设置太短

*解决方案:*

* 增加 `heartbeat.timeoutMs`
* 检查服务器响应时间
* 检查网络延迟
