= Connection Pool
:page-pagination:

The client uses a connection pool to efficiently manage TCP connections. This page explains pool configuration, behavior, reconnection, and heartbeat mechanisms.

== Pool Architecture

[source,text]
----
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ConnectionPool                                     │
│                                                                              │
│  Configuration:                                                              │
│    maxConnections: 10                                                        │
│    minIdle: 2                                                                │
│    maxIdleMs: 60000                                                          │
│    acquireTimeoutMs: 5000                                                    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                         Connection State                                 ││
│  │                                                                          ││
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐       ││
│  │  │ Channel │  │ Channel │  │ Channel │  │ Channel │  │ Channel │       ││
│  │  │  IDLE   │  │  IDLE   │  │ ACTIVE  │  │ ACTIVE  │  │  IDLE   │       ││
│  │  │ 30s ago │  │ 5s ago  │  │ in-use  │  │ in-use  │  │ 10s ago │       ││
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘       ││
│  │       │                          │            │                         ││
│  │       └──────────────────────────┼────────────┘                         ││
│  │                                  │                                       ││
│  └──────────────────────────────────┼───────────────────────────────────────┘│
│                                     │                                        │
│  Idle Queue ◄───────────────────────┘                                        │
│  (available for acquire)                                                     │
└─────────────────────────────────────────────────────────────────────────────┘
----

== Pool Configuration

[source,yaml]
----
spring:
  netty:
    clients:
      - name: order-service
        host: 127.0.0.1
        port: 9000
        profile: tcp-lengthfield-json
        pool:
          maxConnections: 10           # <1>
          minIdle: 2                   # <2>
          maxIdleMs: 60000             # <3>
          acquireTimeoutMs: 5000       # <4>
----
<1> Maximum total connections in pool
<2> Minimum idle connections to maintain
<3> Close idle connections after this time (ms)
<4> Timeout waiting for available connection (ms)

=== Configuration Properties

[cols="2,1,1,4"]
|===
|Property |Default |Type |Description

|`maxConnections`
|`10`
|int
|Maximum number of connections in the pool. Limits concurrent requests.

|`minIdle`
|`2`
|int
|Minimum idle connections to keep ready. Pre-warms the pool.

|`maxIdleMs`
|`60000`
|long
|Maximum time a connection can be idle before eviction (milliseconds).

|`acquireTimeoutMs`
|`5000`
|long
|Maximum time to wait when acquiring a connection (milliseconds).
|===

== Connection Lifecycle

[source,text]
----
                    ┌──────────────────────────────────────────┐
                    │              acquire()                    │
                    │                                          │
                    │    ┌─────────────────────────────────┐   │
                    │    │ 1. Check idle queue             │   │
                    │    │    └─ Has idle? → Return it     │   │
                    │    │                                 │   │
                    │    │ 2. Check pool size              │   │
                    │    │    └─ < max? → Create new       │   │
                    │    │                                 │   │
                    │    │ 3. Wait for available           │   │
                    │    │    └─ Timeout? → Exception      │   │
                    │    └─────────────────────────────────┘   │
                    │                    │                     │
                    │                    ▼                     │
                    │              ┌─────────┐                │
                    │              │ Channel │                │
                    │              │ ACTIVE  │                │
                    │              └─────────┘                │
                    │                    │                     │
                    │           (request/response)             │
                    │                    │                     │
                    │                    ▼                     │
                    │              release()                   │
                    │                    │                     │
                    │    ┌───────────────┼───────────────┐    │
                    │    │               │               │    │
                    │    ▼               ▼               ▼    │
                    │ Healthy?        Broken?        Error?   │
                    │    │               │               │    │
                    │    ▼               ▼               ▼    │
                    │ Return to      Discard &      Discard & │
                    │ idle queue     reconnect      reconnect │
                    │                                          │
                    └──────────────────────────────────────────┘
----

=== Acquire Flow

1. **Check idle queue**: Return an existing idle connection if available
2. **Create new**: If pool not full, create a new connection
3. **Wait**: If pool is full, wait for a connection to become available
4. **Timeout**: If wait exceeds `acquireTimeoutMs`, throw exception

=== Release Flow

1. **Health check**: Verify connection is still valid
2. **Healthy**: Return to idle queue for reuse
3. **Broken**: Discard and trigger reconnection if needed

== Reconnection

The pool automatically reconnects when connections are lost.

=== Configuration

[source,yaml]
----
spring:
  netty:
    clients:
      - name: order-service
        reconnect:
          enabled: true                # <1>
          initialDelayMs: 1000         # <2>
          maxDelayMs: 30000            # <3>
          multiplier: 2.0              # <4>
          maxRetries: -1               # <5>
----
<1> Enable automatic reconnection
<2> Initial delay before first retry (ms)
<3> Maximum delay between retries (ms)
<4> Exponential backoff multiplier
<5> Maximum retry attempts (`-1` = unlimited)

=== Exponential Backoff

[source,text]
----
Connection lost!

Attempt 1: Wait 1000ms  → Connect... Failed
Attempt 2: Wait 2000ms  → Connect... Failed
Attempt 3: Wait 4000ms  → Connect... Failed
Attempt 4: Wait 8000ms  → Connect... Failed
Attempt 5: Wait 16000ms → Connect... Failed
Attempt 6: Wait 30000ms → Connect... Success! (capped at maxDelayMs)
           └─────────────────────────────────┘
                   Exponential backoff
----

Formula: `delay = min(initialDelay * (multiplier ^ attempt), maxDelay)`

=== Reconnection Behavior

[source,text]
----
┌─────────────────────────────────────────────────────────────────┐
│                    ReconnectManager                              │
│                                                                  │
│  State: CONNECTING                                               │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  Event: Connection Lost                                      ││
│  │    │                                                         ││
│  │    ▼                                                         ││
│  │  Schedule reconnect (initialDelayMs)                         ││
│  │    │                                                         ││
│  │    ▼                                                         ││
│  │  Attempt connect                                             ││
│  │    │                                                         ││
│  │    ├─── Success ──► Add to pool, reset backoff               ││
│  │    │                                                         ││
│  │    └─── Failed ───► Calculate next delay                     ││
│  │                       │                                      ││
│  │                       ├─── maxRetries reached? ──► Give up   ││
│  │                       │                                      ││
│  │                       └─── Schedule next attempt             ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
----

== Heartbeat

Heartbeat keeps connections alive and detects dead connections proactively.

=== Configuration

[source,yaml]
----
spring:
  netty:
    clients:
      - name: order-service
        heartbeat:
          enabled: true                          # <1>
          intervalMs: 30000                      # <2>
          timeoutMs: 5000                        # <3>
          message: '{"type":"heartbeat"}'        # <4>
----
<1> Enable heartbeat
<2> Send heartbeat every 30 seconds
<3> Wait up to 5 seconds for response
<4> Heartbeat message content

=== Heartbeat Flow

[source,text]
----
┌─────────────────────────────────────────────────────────────────┐
│                     HeartbeatManager                             │
│                                                                  │
│  Interval: 30000ms                                               │
│  Timeout: 5000ms                                                 │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  For each idle connection:                                   ││
│  │    │                                                         ││
│  │    ▼                                                         ││
│  │  Send: {"type":"heartbeat"}                                  ││
│  │    │                                                         ││
│  │    ├─── Response within 5s ──► Connection healthy            ││
│  │    │                                                         ││
│  │    └─── No response ─────────► Mark unhealthy                ││
│  │                                   │                          ││
│  │                                   ▼                          ││
│  │                               Close & reconnect              ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  Schedule next heartbeat in 30000ms                              │
└─────────────────────────────────────────────────────────────────┘
----

=== Server-Side Heartbeat Handler

Your server should handle heartbeat messages:

[source,java]
----
@NettyMessageController
public class HeartbeatHandler {

    @NettyMessageMapping("heartbeat")
    public Map<String, Object> handleHeartbeat(NettyContext context) {
        return Map.of(
            "type", "heartbeat.ack",
            "timestamp", System.currentTimeMillis()
        );
    }
}
----

== Idle Connection Management

=== Eviction

Connections idle longer than `maxIdleMs` are evicted:

[source,text]
----
Pool State (maxIdleMs = 60000):

  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
  │ Channel │  │ Channel │  │ Channel │  │ Channel │
  │  IDLE   │  │  IDLE   │  │  IDLE   │  │  IDLE   │
  │ 65s ago │  │ 30s ago │  │ 10s ago │  │ 5s ago  │
  └─────────┘  └─────────┘  └─────────┘  └─────────┘
       │
       ▼
    EVICTED (idle > 60s)

After eviction:
  ┌─────────┐  ┌─────────┐  ┌─────────┐
  │ Channel │  │ Channel │  │ Channel │
  │  IDLE   │  │  IDLE   │  │  IDLE   │
  │ 30s ago │  │ 10s ago │  │ 5s ago  │
  └─────────┘  └─────────┘  └─────────┘
----

=== Minimum Idle

The pool maintains at least `minIdle` connections:

[source,text]
----
Pool State (minIdle = 2):

  ┌─────────┐  ┌─────────┐
  │ Channel │  │ Channel │
  │  IDLE   │  │  IDLE   │
  └─────────┘  └─────────┘

All connections released, but minIdle = 2
→ Keep 2 connections ready for next request
----

== Timeouts

=== Connection Timeout

[source,yaml]
----
spring:
  netty:
    clients:
      - name: order-service
        timeout:
          connectMs: 5000              # Connection establishment timeout
----

=== Acquire Timeout

[source,yaml]
----
spring:
  netty:
    clients:
      - name: order-service
        pool:
          acquireTimeoutMs: 5000       # Timeout waiting for pool connection
----

=== Request Timeout

[source,yaml]
----
spring:
  netty:
    clients:
      - name: order-service
        timeout:
          requestMs: 10000             # Request/response timeout
----

== Sizing Guidelines

=== Calculate Max Connections

[source,text]
----
maxConnections = (Requests/Second) × (Average Response Time in Seconds) × Safety Factor

Example:
  - 100 requests/second
  - 50ms average response time (0.05 seconds)
  - 2x safety factor

  maxConnections = 100 × 0.05 × 2 = 10 connections
----

=== Recommendations by Use Case

[cols="2,1,1,3"]
|===
|Use Case |maxConnections |minIdle |Notes

|Low-traffic service
|5
|1
|Minimal resources

|Standard service
|10
|2
|Good balance

|High-traffic service
|50
|10
|Pre-warmed for bursts

|Batch processing
|100
|5
|High parallelism

|Real-time critical
|20
|20
|All connections ready
|===

== Monitoring

=== Pool Metrics

Available via Actuator:

[source,bash]
----
GET /actuator/netty/clients/order-service
----

[source,json]
----
{
  "name": "order-service",
  "host": "127.0.0.1",
  "port": 9000,
  "status": "CONNECTED",
  "pool": {
    "maxConnections": 10,
    "currentSize": 8,
    "activeCount": 3,
    "idleCount": 5,
    "pendingAcquire": 0
  },
  "reconnect": {
    "enabled": true,
    "totalReconnects": 5,
    "lastReconnectTime": "2024-01-30T10:15:30Z"
  }
}
----

=== Micrometer Metrics

[cols="2,3"]
|===
|Metric |Description

|`netty.client.pool.size`
|Current pool size

|`netty.client.pool.active`
|Active (in-use) connections

|`netty.client.pool.idle`
|Idle connections

|`netty.client.pool.pending`
|Requests waiting for connection

|`netty.client.reconnect.total`
|Total reconnection attempts
|===

== Troubleshooting

=== Connection Pool Exhausted

[source,text]
----
ERROR: Failed to acquire connection within 5000ms
----

*Causes:*

* `maxConnections` too low for traffic
* Connections not being released (leak)
* Server too slow, connections occupied

*Solutions:*

* Increase `maxConnections`
* Check for connection leaks
* Add async processing
* Increase server capacity

=== Frequent Reconnections

[source,text]
----
WARN: Reconnecting to order-service (attempt 5)
----

*Causes:*

* Server restarting
* Network instability
* Server rejecting connections

*Solutions:*

* Check server health
* Check network connectivity
* Review server connection limits
* Adjust `maxRetries` and backoff settings

=== Heartbeat Timeout

[source,text]
----
WARN: Heartbeat timeout for connection, marking unhealthy
----

*Causes:*

* Network congestion
* Server overloaded
* `timeoutMs` too short

*Solutions:*

* Increase `heartbeat.timeoutMs`
* Check server response time
* Check network latency
